<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>XR-9: Escape</title>
    <link rel="icon" href="./assets/icon/robot-icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/base.css" />
    <link rel="stylesheet" href="css/hud.css" />
    <link rel="stylesheet" href="css/screens.css" />
    <link rel="stylesheet" href="css/buttons.css" />
    <link rel="stylesheet" href="css/modals.css" />
    <link rel="stylesheet" href="css/responsive.css" />
    <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
  </head>
  <body oncontextmenu="return false;">
    <div class="cabinet">
      <header class="cabinet-header">
        <!-- <span class="cabinet-title">XR-9 ESCAPE</span>
        <span id="speed-indicator" class="cabinet-stat">VEL 350</span> -->
      </header>

      <div class="cabinet-screen">
        <div id="game-container"></div>
        <div id="score" class="score-display">00000 M</div>
        <div id="battery-counter" class="battery-display">
          <span class="battery-icon" aria-hidden="true">
            <svg width="22" height="14" viewBox="0 0 44 28" xmlns="http://www.w3.org/2000/svg" role="img" focusable="false">
              <!-- cuerpo -->
              <rect x="2" y="4" width="36" height="20" rx="3" ry="3" fill="#1e2a36" stroke="#5a7488" stroke-width="2"/>
              <!-- terminal -->
              <rect x="38" y="9" width="4" height="10" rx="1" ry="1" fill="#3b4c5c"/>
              <!-- nivel (decorativo) -->
              <rect x="6" y="8" width="8" height="12" fill="#41ffd9"/>
              <rect x="16" y="8" width="8" height="12" fill="#4fa2ff"/>
              <rect x="26" y="8" width="8" height="12" fill="#9fd6ff"/>
            </svg>
          </span>
          <span id="battery-count">0</span>
        </div>
        <div class="energy-container" aria-label="Energía">
          <span class="energy-text">ENERGIA:</span>
          <div class="energy-track">
            <div id="energy-bar" class="energy-bar ok"></div>
          </div>
        </div>

        <!-- Power-up indicator (centrado arriba) -->
        <div id="powerup-indicator" class="powerup-indicator hidden" aria-live="polite" aria-atomic="true"></div>

        <!-- Intro Overlay (Click to Start) -->
        <div id="intro-overlay" onclick="initializeAudioContext()">
          <div class="intro-text">CLICK TO INITIALIZE SYSTEM</div>
        </div>

        <!-- Transition Overlay (Menu -> Game) -->
        <div id="transition-overlay" class="transition-overlay">
          <div class="transition-text">INITIATING SEQUENCE...</div>
          <div class="loading-bar"><div class="loading-progress"></div></div>
        </div>

        <!-- Include: html/start-screen.html -->
        <div id="start-screen" class="start-panel">
          <button class="help-btn" onclick="playButtonSound(); showControls()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
          </svg>
          </button>
          <div class="start-title">XR-9</div>
          <div class="start-subtitle">ESCAPE</div>
          <div class="start-tagline">// CORREDOR DE FABRICA //</div>
          <button class="start-btn" onclick="playButtonSound(); startGame()">INICIAR JUEGO</button>
          <button class="config-btn" onclick="playButtonSound(); showConfig()"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-.94 1.11-.94h1.093c.55 0 1.02.398 1.11.94l.149.894c.07.424.384.764.78.93.398.164.855.142 1.205-.108l.737-.527a1.125 1.125 0 0 1 1.45.12l.773.774c.39.389.44 1.002.12 1.45l-.527.737c-.25.35-.272.806-.107 1.204.165.397.505.71.93.78l.893.15c.543.09.94.559.94 1.109v1.094c0 .55-.397 1.02-.94 1.11l-.894.149c-.424.07-.764.383-.929.78-.165.398-.143.854.107 1.204l.527.738c.32.447.269 1.06-.12 1.45l-.774.773a1.125 1.125 0 0 1-1.449.12l-.738-.527c-.35-.25-.806-.272-1.203-.107-.398.165-.71.505-.781.929l-.149.894c-.09.542-.56.94-1.11.94h-1.094c-.55 0-1.019-.398-1.11-.94l-.148-.894c-.071-.424-.384-.764-.781-.93-.398-.164-.854-.142-1.204.108l-.738.527c-.447.32-1.06.269-1.45-.12l-.773-.774a1.125 1.125 0 0 1-.12-1.45l.527-.737c.25-.35.272-.806.108-1.204-.165-.397-.506-.71-.93-.78l-.894-.15c-.542-.09-.94-.56-.94-1.109v-1.094c0-.55.398-1.02.94-1.11l.894-.149c.424-.07.765-.383.93-.78.165-.398.143-.854-.108-1.204l-.526-.738a1.125 1.125 0 0 1 .12-1.45l.773-.773a1.125 1.125 0 0 1 1.45-.12l.737.527c.35.25.807.272 1.204.107.397-.165.71-.505.78-.929l.15-.894Z" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
          </svg>
          </button>
          <button id="mute-btn" class="mute-btn" onclick="toggleMenuMusic()">
            <svg id="icon-sound-on" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 0 1 0 12.728M16.463 8.288a5.25 5.25 0 0 1 0 7.424M6.75 8.25l4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" />
            </svg>
            <svg id="icon-sound-off" class="hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 9.75 19.5 12m0 0 2.25 2.25M19.5 12l2.25-2.25M19.5 12l-2.25 2.25m-10.5-6 4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" />
            </svg>
          </button>
          <p class="developer">Desarrollado por: <span class="developer-name">@rafaelestevezdev</span></p>
        </div>

        <!-- Pause overlay -->
        <div id="pause-screen" class="pause-panel">
          <div class="pause-title">PAUSE</div>
          <div class="pause-subtitle">P / ESC PARA CONTINUAR</div>
        </div>

        <!-- Include: html/game-over-screen.html -->
        <div id="game-over-screen" class="game-over-panel">
          <div class="game-over-text">FIN DEL JUEGO</div>
          <div class="game-over-score">
            PUNTUACION FINAL <span id="final-score">0</span>
          </div>
          <div class="game-over-batteries">
            BATERIAS <span id="final-batteries">0</span>
          </div>
          <div class="game-over-buttons">
            <button class="restart-btn" onclick="playButtonSound(); restartGame()">REINICIAR</button>
            <button class="menu-btn" onclick="playButtonSound(); returnToMenu()">MENU PRINCIPAL</button>
          </div>
        </div>

        <!-- Include: html/config-modal.html -->
        <div id="config-modal" class="modal">
          <div class="modal-content">
            <h2>CONFIGURACIÓN</h2>
            <div class="config-section">
              <h3 class="config-subtitle">AUDIO</h3>
              
              <div class="config-label">MÚSICA</div>
              <div class="config-audio-row">
                <span class="icon-speaker" aria-hidden="true">
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 10h3l4-3v10l-4-3H4z" fill="#8bc4ff" stroke="#2e76b3" stroke-width="1.5"/>
                    <path d="M16 8c1.657 1.333 1.657 6.667 0 8" stroke="#8bc4ff" stroke-width="1.5"/>
                    <path d="M18.5 6c2.5 2 2.5 10 0 12" stroke="#4fa2ff" stroke-width="1.5"/>
                  </svg>
                </span>
                <input id="music-volume" class="arcade-range" type="range" min="0" max="100" step="1" value="45" aria-label="Volumen de música"/>
                <span id="music-volume-value" class="range-value">45%</span>
              </div>
              <p class="config-hint">Ajusta el volumen de la música de fondo.</p>

              <div class="config-label">EFECTOS DE SONIDO</div>
              <div class="config-audio-row">
                <span class="icon-speaker" aria-hidden="true">
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 10h3l4-3v10l-4-3H4z" fill="#41ffd9" stroke="#2e76b3" stroke-width="1.5"/>
                    <path d="M16 8c1.657 1.333 1.657 6.667 0 8" stroke="#41ffd9" stroke-width="1.5"/>
                    <path d="M18.5 6c2.5 2 2.5 10 0 12" stroke="#9fd6ff" stroke-width="1.5"/>
                  </svg>
                </span>
                <input id="sfx-volume" class="arcade-range" type="range" min="0" max="100" step="1" value="80" aria-label="Volumen de efectos"/>
                <span id="sfx-volume-value" class="range-value">80%</span>
              </div>
              <p class="config-hint">Ajusta el volumen de los efectos (recoger objetos, etc).</p>
            </div>
            <button class="modal-close-btn" onclick="playButtonSound(); closeModal()">CERRAR</button>
          </div>
        </div>

        <!-- Include: html/controls-modal.html -->
        <div id="controls-modal" class="modal">
          <div class="modal-content">
            <h2>¿CÓMO JUGAR?</h2>
            <p>SALTAR: ESPACIO / ARRIBA / TOCAR</p>
            <h2>OBJETIVO</h2>
            <p>RECOLECTA ⚡ Y EVITA OBSTACULOS</p>
            <button class="modal-close-btn" onclick="playButtonSound(); closeModal()">CERRAR</button>
          </div>
        </div>

        <!-- Orientation Overlay -->
        <div id="orientation-overlay" class="orientation-overlay">
          <div class="orientation-content">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="orientation-icon">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 1.5H8.25A2.25 2.25 0 0 0 6 3.75v16.5a2.25 2.25 0 0 0 2.25 2.25h7.5A2.25 2.25 0 0 0 18 20.25V3.75a2.25 2.25 0 0 0-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-3 18.75h3" />
            </svg>
            <p>POR FAVOR GIRA TU DISPOSITIVO</p>
            <p class="orientation-sub">MEJOR EXPERIENCIA EN HORIZONTAL</p>
          </div>
        </div>

        <!-- Fullscreen Button (Mobile) -->
        <button id="fullscreen-btn" class="fullscreen-btn hidden" onclick="toggleFullscreen()">
          <svg id="icon-fullscreen-enter" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" />
          </svg>
          <svg id="icon-fullscreen-exit" class="hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5M15 15l5.25 5.25" />
          </svg>
        </button>
    </div>
    <script>
      // Button Sound Effect
      const buttonSound = new Audio('assets/sound/sonido_boton.mp3');
      buttonSound.volume = 0.5;

      function playButtonSound() {
        buttonSound.currentTime = 0;
        buttonSound.play().catch(e => console.log("Audio play failed", e));
      }

      // Menu Music
      window.menuMusic = new Audio('assets/music/music_menu.mp3');
      window.menuMusic.loop = true;
      window.isMenuMusicPlaying = false;
      window.isMuted = false;

      // Función explícita para inicializar audio (llamada desde el overlay)
      function initializeAudioContext() {
        const overlay = document.getElementById('intro-overlay');
        
        // Reproducir música
        if (!window.isMuted) {
          window.menuMusic.play().then(() => {
            window.isMenuMusicPlaying = true;
            // Ocultar overlay solo si el audio inicia correctamente
            overlay.classList.add('fade-out');
            setTimeout(() => overlay.style.display = 'none', 500);
          }).catch(e => {
            console.log("Audio init failed", e);
            // Ocultar de todos modos para no bloquear al usuario
            overlay.classList.add('fade-out');
            setTimeout(() => overlay.style.display = 'none', 500);
          });
        } else {
          overlay.classList.add('fade-out');
          setTimeout(() => overlay.style.display = 'none', 500);
        }
      }

      function toggleMenuMusic() {
        const onIcon = document.getElementById('icon-sound-on');
        const offIcon = document.getElementById('icon-sound-off');
        
        window.isMuted = !window.isMuted;
        
        if (window.isMuted) {
          window.menuMusic.pause();
          window.isMenuMusicPlaying = false;
          onIcon.classList.add('hidden');
          offIcon.classList.remove('hidden');
        } else {
          window.menuMusic.play();
          window.isMenuMusicPlaying = true;
          onIcon.classList.remove('hidden');
          offIcon.classList.add('hidden');
        }
      }

      function showConfig() {
        document.getElementById('config-modal').classList.add('show');
      }
      function showControls() {
        document.getElementById('controls-modal').classList.add('show');
      }
      function closeModal() {
        document.querySelectorAll('.modal').forEach(modal => modal.classList.remove('show'));
      }

      // Audio slider logic - Funciones globales
      window.applyMusicVolume = function(percent) {
        const vol = Math.max(0, Math.min(1, percent / 100));
        
        // Aplicar a música del menú
        if (window.menuMusic) window.menuMusic.volume = vol;

        // Aplicar a música del juego (Phaser)
        const scene = window.getGameInstance?.().scene.getScene('GameScene');
        if (scene && scene.bgm) {
          scene.bgm.setVolume(vol);
        }
      };

      window.applySfxVolume = function(percent) {
        const scene = window.getGameInstance?.().scene.getScene('GameScene');
        if (!scene) return;
        const vol = Math.max(0, Math.min(1, percent / 100));
        if (scene.sfxPickup) scene.sfxPickup.setVolume(vol);
      };

      window.setupAudioSliders = function() {
        // Música
        const musicSlider = document.getElementById('music-volume');
        const musicValue = document.getElementById('music-volume-value');
        
        if (musicSlider && musicValue) {
          musicSlider.addEventListener('input', (e) => {
            const v = e.target.value;
            musicValue.textContent = v + '%';
            localStorage.setItem('xr9_music_volume', v);
            window.applyMusicVolume(v);
          });
        }

        // Efectos de sonido
        const sfxSlider = document.getElementById('sfx-volume');
        const sfxValue = document.getElementById('sfx-volume-value');
        
        if (sfxSlider && sfxValue) {
          sfxSlider.addEventListener('input', (e) => {
            const v = e.target.value;
            sfxValue.textContent = v + '%';
            localStorage.setItem('xr9_sfx_volume', v);
            window.applySfxVolume(v);
          });
        }
      };

      // Registrar al cargar el DOM
      document.addEventListener('DOMContentLoaded', window.setupAudioSliders);
    </script>
    <!-- Cargar constantes primero -->
    <script src="js/Constants.js"></script>
    <!-- Cargar clases base -->
    <script src="js/GameState.js"></script>
    <script src="js/TextureGenerator.js"></script>
    <script src="js/BackgroundManager.js"></script>
  <!-- Nueva escena procedural de fondo industrial -->
  <script src="js/EscenaIndustrial.js"></script>
    <script src="js/InputManager.js"></script>
    <script src="js/HUDManager.js"></script>
    <script src="js/PhysicsManager.js"></script>
    <!-- Cargar entidades del juego -->
    <script src="js/Player.js"></script>
    <script src="js/Obstacle.js"></script>
    <script src="js/ObstacleManager.js"></script>
  <script src="js/LaserDrone.js"></script>
  <script src="js/LaserDroneManager.js"></script>
    <!-- Cargar escena principal -->
    <script src="js/GameScene.js"></script>
    <!-- Cargar punto de entrada -->
    <script src="js/main.js"></script>
    
    <!-- Script final para inicializar sliders después de que todo cargue -->
    <script>
      function initializeSliderValues() {
        // Música
        const musicSlider = document.getElementById('music-volume');
        const musicValue = document.getElementById('music-volume-value');
        const savedMusic = localStorage.getItem('xr9_music_volume');
        if (musicSlider && musicValue && savedMusic !== null) {
          musicSlider.value = savedMusic;
          musicValue.textContent = savedMusic + '%';
        }

        // Efectos de sonido
        const sfxSlider = document.getElementById('sfx-volume');
        const sfxValue = document.getElementById('sfx-volume-value');
        const savedSfx = localStorage.getItem('xr9_sfx_volume');
        if (sfxSlider && sfxValue && savedSfx !== null) {
          sfxSlider.value = savedSfx;
          sfxValue.textContent = savedSfx + '%';
        }
      }

      // Ejecutar después de que todo cargue
      window.addEventListener('load', initializeSliderValues);
    </script>
  </body>
</html>
